<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <!-- Meta information -->
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="author" content="Marcos Vanetta (malev)" />
  <meta name="description" content="Authorship and collaboration in open source projects"/>
  <!--Facebook meta -->
  <meta property="og:title" content="Marcos Alejandro Vanetta (malev)" />
  <meta property="og:description" content="Authorship and collaboration in open source projects" />
  <meta property="og:image" content="/images/malev_logo.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- End of facebook meta -->

  <!-- syntax highlighting CSS -->
  <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

  <!-- Homepage CSS -->
  <!-- <link rel="stylesheet" href="/css/bootstrap.css" type="text/css" media="screen, projection" /> -->
  <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="/css/bootstrap-responsive.min.css" type="text/css" media="screen, projection" />
  
  <!-- Google fonts -->
  <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Ubuntu&v2' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Cabin+Sketch:700&v2' rel='stylesheet' type='text/css'>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<!--  <script src="/js/bootstrap.min.js"></script>-->
  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <title>Closures (clausuras)</title>
</head>
<body>
<div class="container">
  <div class="site">
  <div id="post">
    <div class="title">
      <h1><a href='/#blog' name='blog'>Blog posts</a></h1>
    </div>
    <h1>Closures (clausuras)</h1>

<p><strong>Definición</strong>
Un <strong>closure</strong> (clausura) es una funcioń evaluada en un entorno contenido con una o más variables dependientes de otro entorno. Las variables dentro del closure mantienen su vida útil hasta que el closure muere. (un poco trágico). Se usan mucho en programación funcional, en la construcción de objetos y en la construcción de estructuras de control. [1]
<a href="http://blog.malev.com.ar/wp-content/uploads/2010/10/closure.png">
<img src="/images/posts/2010/10/closure-300x288.png" title="closure" alt="" />
</a>
<strong>Definición académica</strong>
"In computer science, a closure is a first-class function with free variables that are bound in the lexical environment." WTF!! [1]</p>

<p><strong>Definición iluminadora</strong>
Los objetos son datos y métodos, los closures son funciones con datos adjuntos.
<em>"Objects are data with methods attached, closures are functions with data attached."</em>[2]</p>

<p><strong>Historia (para los fanáticos de smalltalk)</strong>
El concepto de closure de desarrolló en los 60 y se implementó en un lenguaje llamado Scheme (Así es, no vienen de smalltalk).</p>

<p><strong>Explicación más simple</strong>
Un closure es basicamente una función o método que tiene las siguientes propiedades:
 - Puede pasar como un objeto, inclusive ser llamado después.
 - Recuerda los valores de las variables en su <strong>scope</strong> (alcance) al momento de ser declarado. Puede acceder a estas variables luego, inclusive si ya no se encuentran dentro de su scope. [3]
Entonces un closure puede ser definido en un scope y luego llamado desde otro completamente diferente manteniendo los estados en que fue definido.</p>

<p><strong>Ejemplo - Ruby</strong> [5]</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">SomeClass</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">value1</span><span class="p">)</span>
    <span class="vi">@value1</span> <span class="o">=</span> <span class="n">value1</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">value_printer</span><span class="p">(</span><span class="n">value2</span><span class="p">)</span>
    <span class="nb">lambda</span> <span class="p">{</span><span class="nb">puts</span> <span class="s2">&quot;Value1: </span><span class="si">#{</span><span class="vi">@value1</span><span class="si">}</span><span class="s2">, Value2: </span><span class="si">#{</span><span class="n">value2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">caller</span><span class="p">(</span><span class="n">some_closure</span><span class="p">)</span>
  <span class="n">some_closure</span><span class="o">.</span><span class="n">call</span>
<span class="k">end</span>

<span class="n">some_class</span> <span class="o">=</span> <span class="no">SomeClass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">printer</span> <span class="o">=</span> <span class="n">some_class</span><span class="o">.</span><span class="n">value_printer</span><span class="p">(</span><span class="s2">&quot;some value&quot;</span><span class="p">)</span>

<span class="nb">caller</span><span class="p">(</span><span class="n">printer</span><span class="p">)</span> <span class="c1"># =&gt; Value1: 5, Value2: some value</span>
</code></pre>
</div>


<p><strong>¿Cómo hace el lenguaje para retener el valor de las variables?</strong> [3]
Hay dos opciones (capaz hay más, pero yo encontré estas).
 - El closure crea una copia de todas las variables que necesita cuando es definido.
 - El closure extiende la vida úlil de las variables. No las copia pero mantienen referencia a ellas así no se las lleva el Garbage collector.
<strong>Moraleja</strong>: Si el lenguaje usa la primer forma, entonces muchos closures tendrán su propia copia de las variables; en el 2do caso, los closures solo guardan referencia a la variable. (Python y Ruby usa la 2da forma). [5]</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">SomeClass</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">value1</span><span class="p">)</span>
    <span class="vi">@value1</span> <span class="o">=</span> <span class="n">value1</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">value_incrementer</span>
    <span class="nb">lambda</span> <span class="p">{</span><span class="vi">@value1</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">}</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">value_printer</span>
    <span class="nb">lambda</span> <span class="p">{</span><span class="nb">puts</span> <span class="s2">&quot;value1: </span><span class="si">#{</span><span class="vi">@value1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">some_class</span> <span class="o">=</span> <span class="no">SomeClass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">incrementer</span> <span class="o">=</span> <span class="n">some_class</span><span class="o">.</span><span class="n">value_incrementer</span>
<span class="n">printer</span> <span class="o">=</span> <span class="n">some_class</span><span class="o">.</span><span class="n">value_printer</span>

<span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span>
  <span class="n">incrementer</span><span class="o">.</span><span class="n">call</span>
  <span class="n">printer</span><span class="o">.</span><span class="n">call</span>
<span class="k">end</span>

<span class="no">This</span> <span class="n">produces</span> <span class="n">the</span> <span class="n">following</span> <span class="n">output</span><span class="p">:</span>

<span class="n">alan</span><span class="vi">@alan</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">vm</span><span class="ss">:~</span><span class="sr">/tmp$ ruby closures.rb</span>
<span class="sr">value1: 3</span>
<span class="sr">value1: 4</span>
<span class="sr">value1: 5</span>
</code></pre>
</div>


<p><strong>python</strong>
Este lenguaje implementa los closures mediante la función lambda y mediante funciones dentro de funciones (named closures). Aquí solo vemos el 2do método.</p>

<div class="highlight"><pre><code class="python"><span class="k">def</span> <span class="nf">makeInc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">inc</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
     <span class="c"># x is &quot;closed&quot; in the definition of inc</span>
     <span class="k">return</span> <span class="n">y</span> <span class="o">+</span> <span class="n">x</span>

 <span class="k">return</span> <span class="n">inc</span>

<span class="n">inc5</span> <span class="o">=</span> <span class="n">makeInc</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">inc10</span> <span class="o">=</span> <span class="n">makeInc</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">inc5</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c"># returns 10</span>
<span class="n">inc10</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c"># returns 15</span>
</code></pre>
</div>


<p><strong>Python 3000 - closures</strong>
No funciona en versiones anteriores pues usa la nueva keyword: <strong>nonlocal</strong></p>

<div class="highlight"><pre><code class="python"><span class="k">def</span> <span class="nf">outer</span><span class="p">():</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">():</span>
        <span class="n">nonlocal</span> <span class="n">y</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">y</span>
    <span class="k">return</span> <span class="n">inner</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">outer</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">(),</span> <span class="n">f</span><span class="p">(),</span> <span class="n">f</span><span class="p">())</span> <span class="c">#prints 1 2 3</span>
</code></pre>
</div>


<p>La función anidada inner() declara un closure y lo llama inner.
nota: la función lambda no acepta if o for en su interior.
<strong>Javascript</strong></p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">printMessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">s</span> <span class="o">+</span> <span class="s1">&#39; was pressed.&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">f</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">buttonA</span><span class="p">.</span><span class="nx">onClick</span> <span class="o">=</span> <span class="nx">printMessage</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">);</span>
<span class="nx">buttonB</span><span class="p">.</span><span class="nx">onClick</span> <span class="o">=</span> <span class="nx">printMessage</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">);</span>
<span class="nx">buttonC</span><span class="p">.</span><span class="nx">onClick</span> <span class="o">=</span> <span class="nx">printMessage</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">);</span>
</code></pre>
</div>


<p><strong>Ventajas de los closures</strong>
 - Reemplazan las constantes hard coded
 - Eliminan globals
 - Útiles en los callbacks the systemas orientados a eventos
En [7] hay un listado de usos prácticos de closures en refactoring.
<strong>Bibliografía que leí</strong>
[1] <a href="http://en.wikipedia.org/wiki/Closure_%28computer_science%29">http://en.wikipedia.org/wiki/Closure_%28computer_science%29</a>
[2] <a href="http://stackoverflow.com/questions/13857/can-you-explain-closures-as-they-relate-to-python">http://stackoverflow.com/questions/13857/can-you-explain-closures-as-they-relate-to-python</a>
[3] <a href="http://www.skorks.com/2010/05/closures-a-simple-explanation-using-ruby/">http://www.skorks.com/2010/05/closures-a-simple-explanation-using-ruby/</a>
[4] <a href="http://stackoverflow.com/questions/3145893/how-are-closures-implemented-in-python">http://stackoverflow.com/questions/3145893/how-are-closures-implemented-in-python</a>
[5] <a href="http://samdanielson.com/2007/9/6/an-introduction-to-closures-in-ruby">http://samdanielson.com/2007/9/6/an-introduction-to-closures-in-ruby</a>
[6] <a href="http://ynniv.com/blog/2007/08/closures-in-python.html">http://ynniv.com/blog/2007/08/closures-in-python.html</a>
[7] <a href="http://www.ibm.com/developerworks/java/library/j-cb01097.html">http://www.ibm.com/developerworks/java/library/j-cb01097.html</a>
<strong>Bibliografía que no leí</strong>, pero seguro lo haré pronto
<a href="http://weblog.raganwald.com/2007/01/closures-and-higher-order-functions.html">http://weblog.raganwald.com/2007/01/closures-and-higher-order-functions.html</a>
<a href="http://www.randomhacks.net/articles/2007/02/01/some-useful-closures-in-ruby">http://www.randomhacks.net/articles/2007/02/01/some-useful-closures-in-ruby</a>
<a href="http://www.robertsosinski.com/2008/12/21/understanding-ruby-blocks-procs-and-lambdas/">http://www.robertsosinski.com/2008/12/21/understanding-ruby-blocks-procs-and-lambdas/</a>
<a href="http://www.artima.com/intv/closures.html">http://www.artima.com/intv/closures.html</a></p>

    
      <div class="comments" style="margin-top: 20px;">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'malevsblog'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    
  </div>
  <div id="related">
    <h2><a href='/about.html'>About the author</a></h2>
  </div>

  <div id="related">
    <h2>Related Posts</h2>
    <ul class="posts">
      
        <li><span>01 Jun 2012</span> &raquo; <a href="/backbone-first-steps">Learning Javascript</a></li>
      
        <li><span>13 Apr 2012</span> &raquo; <a href="/nginx-passenger-and-php">Nginx, passenger and PHP</a></li>
      
        <li><span>09 Apr 2012</span> &raquo; <a href="/learning-javascript">Learning Javascript</a></li>
      
    </ul>
  </div>
</div>
  <div class="site">
    <div class="footer">
      <div class="contact">
        <p style="margin:0;">
          <a href="/about.html">Marcos Vanetta</a> <strong>(malev)</strong><br />
          Software engineer<br />
          <a href="http://github.com/malev/">github</a> | <a href="http://twitter.com/malev/">twitter</a> | <a href="http://launchpad.net/~marcosvanetta">Launchpad</a>
        </p>
      </div>
      <div class="rss">
        <a href="http://feeds.feedburner.com/malev">
          <img src="/images/rss-logo.png" alt="Subscribe to RSS Feed" style="width: 64px;"/>
        </a>
      </div>
    </div>
  </div>
</div>
<a href="http://github.com/malev"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29516046-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>
