<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <!-- Meta information -->
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="author" content="Marcos Vanetta (malev)" />
  <meta name="description" content="Authorship and collaboration in open source projects"/>
  <!--Facebook meta -->
  <meta property="og:title" content="Marcos Alejandro Vanetta (malev)" />
  <meta property="og:description" content="Authorship and collaboration in open source projects" />
  <meta property="og:image" content="/images/malev_logo.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- End of facebook meta -->

  <!-- syntax highlighting CSS -->
  <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

  <!-- Homepage CSS -->
  <!-- <link rel="stylesheet" href="/css/bootstrap.css" type="text/css" media="screen, projection" /> -->
  <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="/css/bootstrap-responsive.min.css" type="text/css" media="screen, projection" />
  
  <!-- Google fonts -->
  <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Ubuntu&v2' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Cabin+Sketch:700&v2' rel='stylesheet' type='text/css'>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<!--  <script src="/js/bootstrap.min.js"></script>-->
  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <title>Using Ruby modules in Rails</title>
</head>
<body>
<div class="container">
  <div class="site">
  <div id="post">
    <div class="title">
      <h1><a href='/#blog' name='blog'>Blog posts</a></h1>
    </div>
    <h1>Using Ruby modules in Rails</h1>

<p>El título quizás no sea muy feliz, porque la verdad que es que todo el tiempo estamos usando módulos en Rails. De hecho en Rails 3 podríamos decir que el génesis de cada aplicación rails está contenida en un módulo:</p>

<div class="highlight"><pre><code class="ruby"><span class="c1"># config/application.rb</span>
<span class="k">module</span> <span class="nn">Grouppet</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>


<p>Volviendo a los módulos, ya he hablado de ellos en [1], y en otro post, que ya fue corregido por el [1], así que no vale la pena citarlo aquí.</p>

<p><strong>¿Qué es un módulo en Ruby?</strong>
Son modos de agrupamiento de métodos, clases y constantes. Tienen dos beneficios: proveen un namespace previniendo choques de nombres y soportan mezclado o mixins de una manera fácil [2]. En contraste con las clases, los módulos no pueden: ser instanciados o tener subclases[3]. Por último y aprovechando al lenguaje, un módulo es un objeto.
Aquí, un ejemplo robado de [4]:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">module</span> <span class="nn">Trig</span>
  <span class="no">PI</span> <span class="o">=</span> <span class="mi">3</span><span class="o">.</span><span class="mi">1416</span>
  <span class="c1"># class methods</span>
  <span class="k">def</span> <span class="nc">Trig</span><span class="o">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">&quot;sin(</span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">)&quot;</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nc">Trig</span><span class="o">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># también se podría definir como self.cos(x)</span>
    <span class="nb">puts</span> <span class="s2">&quot;cos(</span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">)&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="no">Trig</span><span class="o">::</span><span class="no">PI</span> <span class="c1"># =&gt; 3.1416</span>
<span class="no">Trig</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span> <span class="c1">#=&gt; cos(90)</span>
</code></pre>
</div>


<p><strong>Modules mixin (mezcla de módulos)</strong>
Los módulos pueden ser incluidos (usando <strong>include</strong>) dentro de las clases y con esto los mezclamos (o al menos eso dice Dave Thomas). Ya he hablado sobre esto en [1], el ejemplo posterior sería como un repaso.</p>

<div class="highlight"><pre><code class="ruby"><span class="k">module</span> <span class="nn">Trig</span>
  <span class="k">def</span> <span class="nf">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">&quot;sin(</span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">)&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Matematica</span>
  <span class="kp">include</span> <span class="no">Trig</span>
<span class="k">end</span>
<span class="n">mat</span> <span class="o">=</span> <span class="no">Matematica</span><span class="o">.</span><span class="n">new</span>
<span class="n">mat</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span> <span class="c1"># =&gt; sin(90)</span>
</code></pre>
</div>


<p>Podemos hacer algo similar usando la palabra clave <strong>extend</strong> pero para agregar métodos de clase:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Matematica2</span>
  <span class="kp">extend</span> <span class="no">Trig</span>
<span class="k">end</span>
<span class="no">Matematica</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span> <span class="c1"># =&gt; sin(90)</span>
</code></pre>
</div>


<p><strong>In a nutshell</strong>
Por un lado lo módulos nos permiten agregar funcionalidad a nuestras clases, algunos los clasifican como la forma que tiene Ruby de soportar herencia múltiple (yo no me siento calificado para hacer esa aseguración). Pero hay un poco más, el código de los módulos que incluimos puede interactuar con el código de nuestra clase. Eso permite hacer cosas fantásticas como: (el ejemplo es de [5])</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">SizeMatters</span>
  <span class="kp">include</span> <span class="no">Comparable</span>
  <span class="kp">attr</span> <span class="ss">:str</span>
  <span class="k">def</span> <span class="nf">&lt;=&gt;</span><span class="p">(</span><span class="n">anOther</span><span class="p">)</span>
    <span class="n">str</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=&gt;</span> <span class="n">anOther</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">size</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="vi">@str</span> <span class="o">=</span> <span class="n">str</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">inspect</span>
    <span class="vi">@str</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">s1</span> <span class="o">=</span> <span class="no">SizeMatters</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span>
<span class="n">s2</span> <span class="o">=</span> <span class="no">SizeMatters</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;YY&quot;</span><span class="p">)</span>
<span class="n">s3</span> <span class="o">=</span> <span class="no">SizeMatters</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;XXX&quot;</span><span class="p">)</span>
<span class="n">s4</span> <span class="o">=</span> <span class="no">SizeMatters</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;WWWW&quot;</span><span class="p">)</span>
<span class="n">s5</span> <span class="o">=</span> <span class="no">SizeMatters</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;VVVVV&quot;</span><span class="p">)</span>

<span class="n">s1</span> <span class="o">&lt;</span> <span class="n">s2</span>                       <span class="c1">#=&gt; true</span>
<span class="n">s4</span><span class="o">.</span><span class="n">between?</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s3</span><span class="p">)</span>           <span class="c1">#=&gt; false</span>
<span class="n">s4</span><span class="o">.</span><span class="n">between?</span><span class="p">(</span><span class="n">s3</span><span class="p">,</span> <span class="n">s5</span><span class="p">)</span>           <span class="c1">#=&gt; true</span>
<span class="o">[</span> <span class="n">s3</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s5</span><span class="p">,</span> <span class="n">s4</span><span class="p">,</span> <span class="n">s1</span> <span class="o">].</span><span class="n">sort</span>   <span class="c1">#=&gt; [Z, YY, XXX, WWWW, VVVVV]</span>
</code></pre>
</div>


<p>Bien, ¿qué hicimos aquí? Al incluir el módulo <strong>Comparable</strong>[5] en nuestra clase le dimos a nuestra clase la capacidad de ordenarse (método <strong>sort</strong>). El único detalle es que nuestra clase debe poder responder al método "&lt;=>", definido en el interior de la misma. ¿Cómo debe responder ese método? Los objetos de nuestra clase van a ser mayores, menores o iguales de acuerdo a cómo queremos nosotros que se comporten. El método &lt;=> debe devolver 1 si el primer elemento es mayor, -1 si es menor o 0 si son iguales.
También podríamos incluir Eumerable[6] y hacer que nuestros objetos sean iterables por ejemplo.</p>

<p><strong>Volviendo al mundo rails</strong>
Mi curiosidad por los módulos viene desde que uso clearance como gema de autenticación en mis proyectos. Clearance incluye métodos en un modelo y en los controladores:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">Clearance</span><span class="o">::</span><span class="no">User</span>
<span class="k">end</span>
<span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">Clearance</span><span class="o">::</span><span class="no">Authentication</span>
<span class="k">end</span>
</code></pre>
</div>


<p>El código fuente de estos módulos se puede navegar en github [7] y [8], en ambos casos podemos ver la inclusión de métodos de clase y de instancia y cómo el buen uso de módulos nos permite (en realidad a los muchachos de thoughtbot) generar excelentes plugins para nuestras aplicaciones rails.
Ahora me pueden decir: yo no escribo gemas ni plugis. ¿Para qué quiero los módulos en rails? La gente de Stac escribió un artículo [9] sobre como organizar modelos cuando estos empiezan a crecer de manera desenfrenada y empiezan a convertirse un desastre. El artículo expone como usar <strong>mixins</strong> para poder organizar nuestros métodos por funcionalidad y así tener código mucho más legible y ordenado.</p>

<div class="highlight"><pre><code class="ruby"><span class="c1"># lib/models/user/friendship_methods.rb</span>
<span class="k">module</span> <span class="nn">Models</span>
  <span class="k">module</span> <span class="nn">User</span>
    <span class="k">module</span> <span class="nn">FriendshipMethods</span>
      <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
      <span class="n">included</span> <span class="k">do</span>
        <span class="n">has_many</span> <span class="ss">:friendships</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="ss">:initiator_id</span>
      <span class="k">end</span>
      <span class="k">module</span> <span class="nn">InstanceMethods</span>
        <span class="k">def</span> <span class="nf">befriend</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
          <span class="nb">self</span><span class="o">.</span><span class="n">friend</span> <span class="o">&lt;&lt;</span> <span class="n">other</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/models/user.rb</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">Models</span><span class="o">::</span><span class="no">User</span><span class="o">::</span><span class="no">FriendshipMethods</span>
<span class="k">end</span>
</code></pre>
</div>


<p>Explicar que hace <strong>ActiveSupport::Concern</strong> escapa la idea de este post, pero pueden buscar info en [10], aunque creo que el código y los comentarios del propio método <strong>concern</strong> se explican por si solo [11]. Recomendación: leer el código fuente a veces está bueno!
También podríamos usar módulos para compartir código entre modelos. Un buen ejemplo sería un sitio que admite comentarios en varios modelos (post, page, etc). Por un lado podríamos usar herencia polimórfica, pero ahí tendríamos que guardar todo en la misma tabla, por otro lado podríamos definir los métodos comunes en un módulo e importarlo en los modelos en donde los necesitamos.</p>

<p><strong>Resources</strong></p>

<ul>
<li>[1] http://blog.malev.com.ar/2010/11/30/include-in-ruby/</li>
<li>[2] Programming Ruby - Dave Thomas</li>
<li>[3] http://www.rubyist.net/~slagell/ruby/modules.html</li>
<li>[4] http://rubylearning.com/satishtalim/modules_mixins.html</li>
<li>[5] http://www.ruby-doc.org/core/classes/Comparable.html</li>
<li>[6] http://www.ruby-doc.org/core/classes/Enumerable.html</li>
<li>[7] https://github.com/thoughtbot/clearance/blob/master/lib/clearance/authentication.rb</li>
<li>[8] https://github.com/thoughtbot/clearance/blob/master/lib/clearance/user.rb</li>
<li>[9] http://wearestac.com/blog/2011/05/organise_your_models</li>
<li>[10] http://en.ihower.tw/post/454873995/rails3-activesupport-concern</li>
<li>[11] https://github.com/rails/rails/blob/master/activesupport/lib/active_support/concern.rb</li>
</ul>


    
      <div class="comments" style="margin-top: 20px;">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'malevsblog'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    
  </div>
  <div id="related">
    <h2><a href='/about.html'>About the author</a></h2>
  </div>

  <div id="related">
    <h2>Related Posts</h2>
    <ul class="posts">
      
        <li><span>01 Jun 2012</span> &raquo; <a href="/backbone-first-steps">Learning Javascript</a></li>
      
        <li><span>13 Apr 2012</span> &raquo; <a href="/nginx-passenger-and-php">Nginx, passenger and PHP</a></li>
      
        <li><span>09 Apr 2012</span> &raquo; <a href="/learning-javascript">Learning Javascript</a></li>
      
    </ul>
  </div>
</div>
  <div class="site">
    <div class="footer">
      <div class="contact">
        <p style="margin:0;">
          <a href="/about.html">Marcos Vanetta</a> <strong>(malev)</strong><br />
          Software engineer<br />
          <a href="http://github.com/malev/">github</a> | <a href="http://twitter.com/malev/">twitter</a> | <a href="http://launchpad.net/~marcosvanetta">Launchpad</a>
        </p>
      </div>
      <div class="rss">
        <a href="http://feeds.feedburner.com/malev">
          <img src="/images/rss-logo.png" alt="Subscribe to RSS Feed" style="width: 64px;"/>
        </a>
      </div>
    </div>
  </div>
</div>
<a href="http://github.com/malev"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29516046-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>
