<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <!-- Meta information -->
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="author" content="Marcos Vanetta (malev)" />
  <meta name="description" content="Authorship and collaboration in open source projects"/>
  <!--Facebook meta -->
  <meta property="og:title" content="Marcos Alejandro Vanetta (malev)" />
  <meta property="og:description" content="Authorship and collaboration in open source projects" />
  <meta property="og:image" content="/images/malev_logo.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- End of facebook meta -->

  <!-- syntax highlighting CSS -->
  <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

  <!-- Homepage CSS -->
  <!-- <link rel="stylesheet" href="/css/bootstrap.css" type="text/css" media="screen, projection" /> -->
  <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="/css/bootstrap-responsive.min.css" type="text/css" media="screen, projection" />
  
  <!-- Google fonts -->
  <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Ubuntu&v2' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Cabin+Sketch:700&v2' rel='stylesheet' type='text/css'>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<!--  <script src="/js/bootstrap.min.js"></script>-->
  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <title>ActiveRecord, a brief introduction - Part 1</title>
</head>
<body>
<div class="container">
  <div class="site">
  <div id="post">
    <div class="title">
      <h1><a href='/#blog' name='blog'>Blog posts</a></h1>
    </div>
    <h1>ActiveRecord, a brief introduction - Part 1</h1>

<p><strong>Active record</strong> es un patrón de diseño. Es un enfoque al problema de acceder a los datos de una base de datos. Donde cada tabla es una clase por lo que cada fila es asociada con objetos del lenguaje de programación usado. Cuando se crea uno de estos objetos, se añade una fila a la tabla de la base de datos. Cuando se modifican los atributos del objeto, se actualiza la fila de la base de datos.[1]</p>

<p><strong>1.- Usos super básicos</strong>[2]</p>

<div class="highlight"><pre><code class="ruby"><span class="c1"># == Schema Information</span>
<span class="c1"># Schema version: 20100829195102</span>
<span class="c1">#</span>
<span class="c1"># Table name: users</span>
<span class="c1">#</span>
<span class="c1">#  id         :integer(4)      not null, primary key</span>
<span class="c1">#  first_name :string(255)</span>
<span class="c1">#  last_name  :string(255)</span>
<span class="c1">#  email      :string(255)</span>
<span class="c1">#</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:posts</span>
<span class="k">end</span>

<span class="c1"># == Schema Information</span>
<span class="c1"># Schema version: 20100829195102</span>
<span class="c1">#</span>
<span class="c1"># Table name: posts</span>
<span class="c1">#</span>
<span class="c1">#  id         :integer(4)      not null, primary key</span>
<span class="c1">#  title      :string(255)</span>
<span class="c1">#  body       :text</span>
<span class="c1">#  state      :string(255)</span>
<span class="c1">#  user_id    :integer(4)</span>
<span class="c1">#  created_at :datetime</span>
<span class="c1">#  updated_at :datetime</span>
<span class="c1">#</span>

<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span>
</code></pre>
</div>


<p><strong>Agregando datos:</strong>
1.1) Atributo por atributo</p>

<div class="highlight"><pre><code class="ruby"><span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="n">u</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">&quot;Marcos&quot;</span>
<span class="n">u</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="s2">&quot;Vanetta&quot;</span>
<span class="n">u</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;marcos@correo.com&quot;</span>
<span class="n">u</span><span class="o">.</span><span class="n">save</span>
</code></pre>
</div>


<p>1.2) Pasando todos los atributos con un diccionario</p>

<div class="highlight"><pre><code class="ruby"><span class="n">u2</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span> <span class="ss">:first_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span> <span class="ss">:last_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Doe&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;johndoe@correo.com&quot;</span>
</code></pre>
</div>


<p><strong>nota:</strong> Aquí no es necesario el save</p>

<p>1.3) Actualizando un atributo en particular:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">u</span><span class="o">.</span><span class="n">update_attribute</span> <span class="ss">:email</span><span class="p">,</span> <span class="s2">&quot;johndoe@gmail.com&quot;</span>
</code></pre>
</div>


<p>Nota: Este procedimiento <strong>no incurre en validaciones</strong>, vea también [3]</p>

<p>1.4) Actualizando con un diccionario:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="n">u</span><span class="o">.</span><span class="n">update_attributes</span> <span class="ss">:first_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Dexter&quot;</span><span class="p">,</span> <span class="ss">:last_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Morgan&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;dexter@morgan.com&quot;</span>
</code></pre>
</div>


<p>nota: update_attributes! Es igual al anterior, pero sin validaciones.</p>

<p>1.5) Eliminar un registro:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">last</span>
<span class="n">u</span><span class="o">.</span><span class="n">destroy</span>
</code></pre>
</div>


<p><strong>Búsquedas simples</strong>
2.1) Obtener todos los registros:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>
<span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span> <span class="c1"># =&gt; Alias para el anterior</span>
</code></pre>
</div>


<p>nota: Nunca recomendable. Si hay una gran cantidad de registros se puede dar un gran consumo de memoria.</p>

<div class="highlight"><pre><code class="ruby"><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="ss">:offset</span> <span class="o">=&gt;</span> <span class="mi">0</span>
<span class="c1"># Muestra los primeros 10. Manipulando :limit y :offset, se pude obtener un paginado de los recursos.</span>
</code></pre>
</div>


<p>2.2) Obtener registros en particular (x ID)</p>

<div class="highlight"><pre><code class="ruby"><span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">last</span>
<span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span> <span class="mi">7</span>
<span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span> <span class="o">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span> <span class="p">,</span> <span class="mi">10</span><span class="o">]</span> <span class="c1"># Entrega 3 elementos con ID: 7, 9 y 10</span>
</code></pre>
</div>


<p>2.2.1) Tipos de respustas
Ante cada consulta AR nos puede devolver 2 tipos de objetos: un objeto AR (el que buscamos o solicitamos). O un arreglo de objetos AR:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="n">u</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span> <span class="c1"># =&gt; &quot;User&quot;</span>

<span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span> <span class="o">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="o">]</span>
<span class="n">u</span><span class="o">.</span><span class="n">class</span> <span class="c1"># =&gt; Array</span>
</code></pre>
</div>


<p>Esto es muy importante a la hora de armar las vistas. Si nosotros solicitamos un objeto y AR no lo encuentra, nos devuelve "<strong>nil</strong>", por lo que tendremos que contemplar esta posibilidad en la vista. En cambio cuando hacemos una solicitud de un arreglo, AR nos puede devolver: un arreglo de objetos (<strong>array</strong>), un arreglo con un único elemento o un arreglo vacío. Aquí no suelen aparecer problemas ya que en genera en la vista usamos: objeto.each do ... y en caso de que el arreglo este vacío, no se da ninguna iteración, pero tampoco salta ninguna exeption.</p>

<p>2.3) Usando dynamic finders
En pos de la legibilidad rails genera "buscadores dinámicos" asociados a los atributos de la tabla:</p>

<div class="highlight"><pre><code class="ruby"><span class="c1"># Devuelven un objeto AR</span>
<span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span> <span class="s2">&quot;marcos@correo.com&quot;</span>
<span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_last_name</span> <span class="s2">&quot;Vanetta&quot;</span>
<span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_first_name</span> <span class="s2">&quot;Marcos&quot;</span>

<span class="c1"># Devuelven un arreglo de objetos AR</span>
<span class="nb">p</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">find_all_by_title</span> <span class="s2">&quot;Et&quot;</span>
</code></pre>
</div>


<p>2.4) Búsquedas con condiciones</p>

<div class="highlight"><pre><code class="ruby"><span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span> <span class="ss">:first_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Marcos&quot;</span>
<span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span> <span class="ss">:all</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;first_name = ?&quot;</span><span class="p">,</span> <span class="s2">&quot;Natalie&quot;</span><span class="o">]</span>
<span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;first_name = ?&quot;</span><span class="p">,</span> <span class="s2">&quot;Natalie&quot;</span><span class="o">]</span>
<span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;first_name = ? AND last_name = ?&quot;</span><span class="p">,</span> <span class="s2">&quot;Natalie&quot;</span><span class="p">,</span> <span class="s2">&quot;Erdman&quot;</span><span class="o">]</span>
<span class="n">u</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">all</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="ss">:offset</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;state &lt;&gt; ?&quot;</span><span class="p">,</span> <span class="s2">&quot;unsearchable&quot;</span><span class="o">]</span>
</code></pre>
</div>


<p>2.5) Más condiciones</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">p</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">all</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="ss">:offset</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;state &lt;&gt; ? AND body LIKE ?&quot;</span><span class="p">,</span> <span class="s2">&quot;unsearchable&quot;</span><span class="p">,</span> <span class="s2">&quot;%Texto%&quot;</span><span class="o">]</span>
<span class="nb">p</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">all</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;user_id = ? AND state = ?&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;draft&quot;</span><span class="o">]</span>
</code></pre>
</div>


<p>2.6) Condiciones con un Array
p = Post.all :limit => 10, :conditions => ["state IN (?)", ["published", "draft"]]
Podemos notar tuvimos que agregar el IN(?) para que la consulta se haga de manera correcta.</p>

<p>2.7) Conditions' hash</p>

<div class="highlight"><pre><code class="ruby"><span class="o">&gt;&gt;</span> <span class="nb">p</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">all</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:state</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;published&quot;</span><span class="p">,</span> <span class="s2">&quot;draft&quot;</span><span class="o">]</span><span class="p">}</span>
  <span class="no">Post</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">57</span><span class="o">.</span><span class="mi">6</span><span class="n">ms</span><span class="p">)</span>   <span class="no">SELECT</span> <span class="o">*</span> <span class="no">FROM</span> <span class="sb">`posts`</span> <span class="no">WHERE</span> <span class="p">(</span><span class="sb">`posts`</span><span class="o">.</span><span class="n">`state</span><span class="sb">` IN (&#39;published&#39;,&#39;draft&#39;))</span>
</code></pre>
</div>


<p><strong>Y, esta es la posta! </strong>Por que no necesitamos aclarar en la consulta si es un = on un IN.
Otro ejemplo:</p>

<div class="highlight"><pre><code class="ruby"><span class="o">&gt;&gt;</span> <span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:last_name</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">}</span>
  <span class="no">User</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>   <span class="no">SELECT</span> <span class="o">*</span> <span class="no">FROM</span> <span class="sb">`users`</span> <span class="no">WHERE</span> <span class="p">(</span><span class="sb">`users`</span><span class="o">.</span><span class="n">`last_name</span><span class="sb">` IS NULL)</span>
</code></pre>
</div>


<p>2.8) Range conditions</p>

<div class="highlight"><pre><code class="ruby"><span class="o">&gt;&gt;</span> <span class="nb">p</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">all</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">midnight</span> <span class="o">-</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">.</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">midnight</span><span class="p">}</span>
    <span class="no">Post</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">25</span><span class="o">.</span><span class="mi">8</span><span class="n">ms</span><span class="p">)</span>   <span class="no">SELECT</span> <span class="o">*</span> <span class="no">FROM</span> <span class="sb">`posts`</span> <span class="no">WHERE</span> <span class="p">(</span><span class="sb">`posts`</span><span class="o">.</span><span class="n">`created_at</span><span class="sb">` BETWEEN &#39;2010-08-28 00:00:00&#39; AND &#39;2010-08-29 00:00:00&#39;) </span>
<span class="sb">&gt;&gt; p = Post.all :conditions =&gt; {:user_id =&gt; (3..4)}</span>
<span class="sb">  Post Load (27.5ms)   SELECT * FROM `</span><span class="n">posts</span><span class="sb">` WHERE (`</span><span class="n">posts</span><span class="sb">`.`</span><span class="n">user_id</span><span class="sb">` BETWEEN 3 AND 4)</span>
</code></pre>
</div>


<p>Esta es la primer entrega de este mini tutorial. La idea es hacer un repaso de AR desde cosas super básicas como estas, hasta algunas un poco más avanzadas.</p>

<p>[1]<a href="http://es.wikipedia.org/wiki/Patr%C3%B3n_ActiveRecord"> http://es.wikipedia.org/wiki/Patr%C3%B3n_ActiveRecord</a>
[2] <a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html">http://api.rubyonrails.org/classes/ActiveRecord/Base.html</a>
[3] <a href="http://blog.malev.com.ar/2010/08/04/bang-methods-in-activerecord/">http://blog.malev.com.ar/2010/08/04/bang-methods-in-activerecord/</a>
[4] <a href="http://railscasts.com/episodes/15-fun-with-find-conditions">http://railscasts.com/episodes/15-fun-with-find-conditions</a></p>

    
      <div class="comments" style="margin-top: 20px;">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'malevsblog'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    
  </div>
  <div id="related">
    <h2><a href='/about.html'>About the author</a></h2>
  </div>

  <div id="related">
    <h2>Related Posts</h2>
    <ul class="posts">
      
        <li><span>01 Jun 2012</span> &raquo; <a href="/backbone-first-steps">Learning Javascript</a></li>
      
        <li><span>13 Apr 2012</span> &raquo; <a href="/nginx-passenger-and-php">Nginx, passenger and PHP</a></li>
      
        <li><span>09 Apr 2012</span> &raquo; <a href="/learning-javascript">Learning Javascript</a></li>
      
    </ul>
  </div>
</div>
  <div class="site">
    <div class="footer">
      <div class="contact">
        <p style="margin:0;">
          <a href="/about.html">Marcos Vanetta</a> <strong>(malev)</strong><br />
          Software engineer<br />
          <a href="http://github.com/malev/">github</a> | <a href="http://twitter.com/malev/">twitter</a> | <a href="http://launchpad.net/~marcosvanetta">Launchpad</a>
        </p>
      </div>
      <div class="rss">
        <a href="http://feeds.feedburner.com/malev">
          <img src="/images/rss-logo.png" alt="Subscribe to RSS Feed" style="width: 64px;"/>
        </a>
      </div>
    </div>
  </div>
</div>
<a href="http://github.com/malev"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29516046-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>
